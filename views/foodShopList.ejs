<!DOCTYPE html>
<html lang="ko">
<head>

    <title>맛집</title>
    <meta name="title" content="">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">

    <meta name="keywords" content="">
    <meta name="description" content="">

    <meta property="og:url" content="">
    <meta property="og:image" content="">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Samsung">
    <meta property="og:locale" content="ko">
    <meta property="og:title" content="">
    <meta property="og:description" content="">
    <meta property="og:country-name" content="">

    <meta itemprop="name" content="Samsung">
    <meta itemprop="image" content="">
    <meta itemprop="url" content="">
    <meta itemprop="description" content="">
    <meta itemprop="keywords" content="">

    <style type="text/css">
        #restaurant_find_local_map{width:100%;height:50%;}
    </style>

    <link rel="stylesheet" href="/css/style.css" type="text/css">
    <script type="text/javascript" src="/js/ios_scalable.js"></script>
    <script type ="text/javascript" src="/js/jquery-1.11.2.min.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=HzG9TZi2bzeiGmAPQyV0eAPYzea02TbU"></script>
</head>

<body>
<div id="restaurant_find_local_map"></div>
<div id="container">
            <div id="restaurant_find_local_list_wrap"></div>
        <div id="restaurant_find_local_list_wrap_empty"></div>
    </div>
</div>
<input type="hidden" id='nickName' value=<%=nickName%>>
</body>
</html>

<script type ="text/javascript">
    $(function(){
        var map = new BMap.Map("restaurant_find_local_map");

        var navigationControl = new BMap.NavigationControl({
            anchor: BMAP_ANCHOR_BOTTOM_LEFT,
            type: BMAP_NAVIGATION_CONTROL_LARGE,
            enableGeolocation: true
        });

        var geolocationControl = new BMap.GeolocationControl({
            anchor: BMAP_ANCHOR_BOTTOM_RIGHT,
            type: BMAP_NAVIGATION_CONTROL_LARGE,
            enableGeolocation: true
        })

        map.addControl(navigationControl);
        map.addControl(geolocationControl);

        getLocation();

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(getPosition);
            } else {
                console.log('Error', 'Geolocation is not supported by this browser."');
            }
        }

        function getPosition(position) {

            var longitude = position.coords.longitude;
            var latitude = position.coords.latitude;

            var mPoint = new BMap.Point(longitude, latitude);
            map.enableScrollWheelZoom();
            map.centerAndZoom(mPoint, 14);

            var mkr = new BMap.Marker(mPoint);
            map.addOverlay(mkr);

            $.ajax({
                url: 'http://nbnl.couphone.cn/food/currentLocation',
//                url: 'http://localhost:8080/food/currentLocation',
                type: 'POST',
                data: {lng : longitude,
                        lat : latitude},
                success: function (data) {

                    var addr = data.address;
                    console.log('data food myMpoint', addr);

                    getFoodShop(map, addr, longitude, latitude);

                    map.addEventListener("dragend", function () {
                        getFoodShop(map, addr, longitude, latitude);
                    });

                    var isFirst = true;

                    map.addEventListener("zoomend", function () {
                        if (!isFirst) {
                            getFoodShop(map, addr, longitude, latitude);
                        }
                        isFirst = false;
                    });
                },
                error: function (request, status, error) {
                    console.log("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
                    console.log('Error occured');
                }
            })
        }
    });

    var getFoodShop = function(map, address, lng, lat) {

        var data = {
                        neLat: map.getBounds().getNorthEast().lat,
                        neLng: map.getBounds().getNorthEast().lng,
                        swLat: map.getBounds().getSouthWest().lat,
                        swLng: map.getBounds().getSouthWest().lng,
                        address : address,
                        lng : lng,
                        lat : lat
                    };

        $.ajax({
              url: 'http://nbnl.couphone.cn/food/shopList',
//            url: 'http://127.0.0.1:8080/food/shopList',
            type: 'POST',
            data: data,
            success: function (data) {
                $('#restaurant_find_local_list_wrap').empty();
                $('#restaurant_find_local_list_wrap_empty').empty();

                var geoCodeSet = new Array();

                if(data.data.length < 1){
                 var dynamicDom = '<div class="body_middle ic_buy_basket_middle_food">' +
                                        '<p class="ic_buy_basket"><img src="/images/ic_food_empty@3x.png"></p>' +
                                        '<p class="fontsize16 fontmedium dimmed_btn">근처에 추천 맛집이 없습니다.</p>' +
                                    '</div>'
                    $('#restaurant_find_local_list_wrap_empty').append(dynamicDom);
                }else{
                    $.each(data.data, function (index, value) {
                        var foodId = value.FOOD_ID;
                        var foodNameCn = value.FOOD_NAME_CN;
                        var foodNameKr = value.FOOD_NAME_KR;
                        var foodTypeKr = value.FOOD_TYPE_KR;
                        var foodScope = value.FOOD_SCOPE;
                        var capitaPrice = value.CAPITA_PRICE;
                        var longitude = value.LONGITUDE_WALK;
                        var latitude = value.LATITUDE_WALK;
                        var address = value.ADDRESS;
                        var lat = value.LAT;
                        var lng = value.LNG;
                        var parameter = "'transport" + (index + 1) + "'";
                        var dynamicDom = '<form id="transport' + (index + 1) + '" action="/food/transport" method="get" enctype="application/x-www-form-urlencoded">' +
                            '<input type="hidden" name="id" value="' + foodId + '">' +
                            '<input type="hidden" name="type" value="walking">' +
                            '<input type="hidden" name="address" value="'+ address+'">' +
                            '<input type="hidden" name="lat" value="'+ lat +'">' +
                            '<input type="hidden" name="lng" value="'+ lng +'">' +
                            '<input type="hidden" name="nickName" value="'+ $('#nickName').val() +'">' +
                            '<div id="restaurant_find_local_list">' +
                            '<div class="fir"><span class="ic_last_pin">' + (index + 1) + '</span></div>' +
                            '<a href = "/food/shopInfo?id=' + foodId + '&address=' + address +'&lat='+lat +'&lng='+lng+'&nickName='+ $('#nickName').val() +'"><div class="sec"><ul class="info">' +
                            '<li class="res_name">' + foodNameCn + '<span class="kor">' + '(' + foodNameKr + ')' + '</span></li>' +
                            '<li class="price">' + foodTypeKr + '</li>' +
                            '<li class="star">';
                        dynamicDom = getRating(foodScope, dynamicDom);
                        dynamicDom += '<span class="txt">' + foodScope + ' ・ ' + capitaPrice + '</span>' +
                            '</li>' +
                            '</ul></div></a>' +
                            '<div class="thi"><span class="icon" onclick="document.getElementById(' + parameter + ').submit();"><img src="/images/btn_ic_direction@3x.png"></a></span></div>' +
                            '<div class="clear_both"></div>' +
                            '</div></form>';

                        $('#restaurant_find_local_list_wrap').append(dynamicDom);
                        geoCodeSet.push({longitude: longitude, latitude: latitude}); // 위도 경도 셋
                    });
                }

                pointMap(map, geoCodeSet);
            },
            error: function (request, status, error) {
                console.log("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
                console.log('Error occured');
            }
        })
    }

    // 별점 평점 계산
    var getRating = function(foodScope, dynamicDom) {
        var rating = foodScope * 2;
        var fullStar = foodScope;
        var halfStar = false;

        // 별 반개가 남으면 홀수, 아니면 짝수
        if (rating % 2 == 1) {
            halfStar = true;
            fullStar -= 0.5;
        }

        for (var i = 1; i <= 5; i++) {
            if (i <= fullStar) {
                dynamicDom += '<img src="/images/star@3x.png">';
            } else if (halfStar) {
                dynamicDom += '<img src="/images/star_half@3x.png">';
                halfStar = false;
            } else {
                dynamicDom += '<img src="/images/star_dim@3x.png" alt="딤드별">';
            }
        }
        return dynamicDom;
    }

    // 지도 맵
    var pointMap = function (map, geoCodeSet) {
        var points = new Array();
        for(var i in geoCodeSet){
            points.push(new BMap.Point(geoCodeSet[i].longitude, geoCodeSet[i].latitude));
        }
        for(var i in points){
            map.addOverlay(new BMap.Marker(points[i]));
        }
    }
</script>