<!DOCTYPE html>
<html lang="ko">
<head>

    <title>Samsung</title>
    <meta name="title" content="">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">

    <meta name="keywords" content="">
    <meta name="description" content="">

    <meta property="og:url" content="">
    <meta property="og:image" content="">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Samsung">
    <meta property="og:locale" content="ko">
    <meta property="og:title" content="">
    <meta property="og:description" content="">
    <meta property="og:country-name" content="">

    <meta itemprop="name" content="Samsung">
    <meta itemprop="image" content="">
    <meta itemprop="url" content="">
    <meta itemprop="description" content="">
    <meta itemprop="keywords" content="">
    <style type="text/css">
        #restaurant_find_local_map{width:100%;height:50%;}
    </style>
    <link rel="stylesheet" href="/css/style.css" type="text/css">
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=HzG9TZi2bzeiGmAPQyV0eAPYzea02TbU"></script>
    <script type ="text/javascript" src="/js/jquery-1.11.2.min.js"></script>
    <script type="text/javascript" src="/js/ios_scalable.js"></script>
</head>

<body>
<div id="container">
    <a href="/food"><p class="back_arrow"><img src="/images/btn_back_w@3x.png"></a>
    <div id="header">
        <span class="part"></span><span class="head_ti">맛집</span>
    </div>
        <div id="restaurant_find_local_map"></div>
        <!--<form id='transport' action="/food/transport" method="post" enctype="application/x-www-form-urlencoded">-->
            <div id="restaurant_find_local_list_wrap"></div>
        <!--</form>-->
    </div>
</div>
</body>
</html>

<script type ="text/javascript">


    $(function(){
        var map = new BMap.Map("restaurant_find_local_map");

        var navigationControl = new BMap.NavigationControl({
            anchor: BMAP_ANCHOR_BOTTOM_LEFT,
            type: BMAP_NAVIGATION_CONTROL_SMALL,
            enableGeolocation: true
        });
        map.addControl(navigationControl);
        var geolocationControl = new BMap.GeolocationControl();
        var addressComponent = geolocationControl.getAddressComponent();

        var address = '';
        var addressComponent = {
            province : '上海市',
            city : '上海市',
            district : '黄浦区',
            street : '百翎路',
            streetNumber :'1号'
        }

        address += addressComponent.province;
        address += addressComponent.city;
        address += addressComponent.district;
        address += addressComponent.street;
        address += addressComponent.streetNumber;

        if(address != '' && address != undefined && address!= null){

            console.log('############ address :: ', address);

            $.ajax({
            url: 'http://nbnl.couphone.cn:8080/food/currentLocation',
//                url: 'http://localhost:8080/food/currentLocation',
                type: 'POST',
                data: {addr : address},
                success: function (data) {
                    var mPoint = new BMap.Point(data.lng, data.lat);
                    map.enableScrollWheelZoom();
                    map.centerAndZoom (mPoint, 14);

                    getFoodShop(map, address, data.lng, data.lat);
                },
                error: function (request, status, error) {
                    console.log("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
                    console.log('Error occured');
                }
            })
        }

        map.addEventListener("dragend", function () {
            getFoodShop(map, null);
        });

//        map.addEventListener("zoomend", function() {
//            getFoodShop(map, null);
//        });
    });

    var getFoodShop = function(map, address, lng, lat) {

        var data = {
                        neLat: map.getBounds().getNorthEast().lat,
                        neLng: map.getBounds().getNorthEast().lng,
                        swLat: map.getBounds().getSouthWest().lat,
                        swLng: map.getBounds().getSouthWest().lng,
                        address : address,
                        lng : lng,
                        lat : lat
                    };

        $.ajax({
              url: 'http://nbnl.couphone.cn:8080/food/shopList',
//            url: 'http://127.0.0.1:8080/food/shopList',
            type: 'POST',
            data: data,
            success: function (data) {
                $('#restaurant_find_local_list_wrap').empty();

                var geoCodeSet = new Array();
                $.each(data.data, function (index, value) {
                    var foodId = value.FOOD_ID;
                    var foodNameCn = value.FOOD_NAME_CN;
                    var foodNameKr = value.FOOD_NAME_KR;
                    var foodTypeKr = value.FOOD_TYPE_KR;
                    var foodScope = value.FOOD_SCOPE;
                    var capitaPrice = value.CAPITA_PRICE;
                    var longitude = value.LONGITUDE_WALK;
                    var latitude = value.LATITUDE_WALK;
                    var address = value.ADDRESS;
                    var lat = value.LAT;
                    var lng = value.lng;
                    var parameter = "'transport" + (index + 1) + "'";

                    var dynamicDom = '<form id="transport' + (index + 1) + '" action="/food/transport" method="get" enctype="application/x-www-form-urlencoded">' +
                        '<input type="hidden" name="id" value="' + foodId + '">' +
                        '<input type="hidden" name="type" value="walking">' +
                        '<input type="hidden" name="address" value="'+ address+'">' +
                        '<input type="hidden" name="lat" value="'+ lat +'">' +
                        '<input type="hidden" name="lng" value="'+ lng +'">' +
                        '<div id="restaurant_find_local_list">' +
                        '<div class="fir"><span class="ic_last_pin">' + (index + 1) + '</span></div>' +
                        '<a href = "/food/shopInfo?id=' + foodId + '"><div class="sec"><ul class="info">' +
                        '<li class="res_name">' + foodNameCn + '<span class="kor">' + '(' + foodNameKr + ')' + '</span></li>' +
                        '<li class="price">' + foodTypeKr + '</li>' +
                        '<li class="star">';
                    dynamicDom = getRating(foodScope, dynamicDom);
                    dynamicDom += '<span class="txt">' + foodScope + ' ・ ' + capitaPrice + '</span>' +
                        '</li>' +
                        '</ul></div></a>' +
                        '<div class="thi"><span class="icon" onclick="document.getElementById(' + parameter + ').submit();"><img src="/images/btn_ic_direction@3x.png"></a></span></div>' +
                        '<div class="clear_both"></div>' +
                        '</div></form>';

                    $('#restaurant_find_local_list_wrap').append(dynamicDom);
                    geoCodeSet.push({longitude: longitude, latitude: latitude}); // 위도 경도 셋
                });

                pointMap(map, geoCodeSet);
            },
            error: function (request, status, error) {
                console.log("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
                console.log('Error occured');
            }
        })
    }

    // 별점 평점 계산
    var getRating = function(foodScope, dynamicDom) {
        var rating = foodScope * 2;
        var fullStar = foodScope;
        var halfStar = false;

        // 별 반개가 남으면 홀수, 아니면 짝수
        if (rating % 2 == 1) {
            halfStar = true;
            fullStar -= 0.5;
        }

        for (var i = 1; i <= 5; i++) {
            if (i <= fullStar) {
                dynamicDom += '<img src="/images/star@3x.png">';
            } else if (halfStar) {
                dynamicDom += '<img src="/images/star_half@3x.png">';
                halfStar = false;
            } else {
                dynamicDom += '<img src="/images/star_dim@3x.png" alt="딤드별">';
            }
        }
        return dynamicDom;
    }

    // 지도 맵
    var pointMap = function (map, geoCodeSet) {
        var points = new Array();
        for(var i in geoCodeSet){
            points.push(new BMap.Point(geoCodeSet[i].longitude, geoCodeSet[i].latitude));
        }
        for(var i in points){
            map.addOverlay(new BMap.Marker(points[i]));
        }
    }

    //    var getLocation = function() {
    //        if (navigator.geolocation) {
    //            navigator.geolocation.getCurrentPosition(showPosition);
    //        } else {
    //            console.log('Geolocation is not supported by this browser.');
    //        }
    //    }
    //    var showPosition = function(position) {
    //        console.log('position', position);
    //        console.log('latitude', position.coords.latitude);
    //        console.log('longitude', position.coords.longitude)
    //        return new BMap.Point(position.coords.longitude, position.coords.latitude);
    //    }
</script>